<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>Hello WebXR8!</title>
    <!-- Importar Three.js -->
    <script src="https://unpkg.com/three@0.126.0/build/three.js"></script>
    <script src="https://unpkg.com/three@0.126.0/examples/js/loaders/GLTFLoader.js"></script>
</head>
<body>
    <!-- Botón para iniciar la experiencia de AR -->
    <button onclick="activateXR()">Start Hello WebXR</button>

    <script>
        async function activateXR() {
            try {
                // Crear un canvas para el contexto WebGL
                const canvas = document.createElement("canvas");
                document.body.appendChild(canvas);
                const gl = canvas.getContext("webgl", {xrCompatible: true});

                // Crear la escena de Three.js
                const scene = new THREE.Scene();

                //Colocar luz
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.3);
                directionalLight.position.set(10, 15, 10);
                scene.add(directionalLight);

                // Configurar el renderizador de Three.js
                const renderer = new THREE.WebGLRenderer(
                {
                    alpha: true,
                    preserveDrawingBuffer: true,
                    canvas: canvas,
                    context: gl
                });
                renderer.autoClear = false;

                // Configurar la cámara de Three.js
                const camera = new THREE.PerspectiveCamera();
                camera.matrixAutoUpdate = false;

                // Iniciar la sesión de WebXR
                const session = await navigator.xr.requestSession("immersive-ar", {requiredFeatures: ['hit-test']});
                session.updateRenderState(
                {
                    baseLayer: new XRWebGLLayer(session, gl)
                });
                const referenceSpace = await session.requestReferenceSpace('local');

                // Create another XRReferenceSpace that has the viewer as the origin.
                const viewerSpace = await session.requestReferenceSpace('viewer');
                // Perform hit testing using the viewer as origin.
                const hitTestSource = await session.requestHitTestSource({ space: viewerSpace });

                //Crear el retículo
                const loader = new THREE.GLTFLoader();
                let reticle;
                loader.load("https://immersive-web.github.io/webxr-samples/media/gltf/reticle/reticle.gltf", function(gltf) 
                {
                    reticle = gltf.scene;
                    reticle.visible = false;
                    scene.add(reticle);
                })

                //Crear el modelo
                let fish;
                loader.load("ShipPrefab.glb", function(gltf) 
                {
                    fish = gltf.scene;
                    reticle.visible = false; //Desactivar el reticulo una vez se carga el modelo
                });

                // Añadir evento de selección
                session.addEventListener("select", (event) => {
                    if (fish) 
                    {
                        const clone = fish.clone();
                        clone.position.copy(reticle.position);
                        scene.add(clone);
                        reticle.visible = false; // Desactivar el retículo una vez que se carga el modelo
                    }
                });

                // Crear el bucle de renderizado de la escena de AR
                const onXRFrame = (time, frame) => 
                {
                    session.requestAnimationFrame(onXRFrame);

                    gl.bindFramebuffer(gl.FRAMEBUFFER, session.renderState.baseLayer.framebuffer); // Aquí se enlaza el framebuffer

                    const pose = frame.getViewerPose(referenceSpace);
                    if (pose) 
                    {
                        const view = pose.views[0];
                        const viewport = session.renderState.baseLayer.getViewport(view);
                        renderer.setSize(viewport.width, viewport.height);
                        camera.matrix.fromArray(view.transform.matrix);
                        camera.projectionMatrix.fromArray(view.projectionMatrix);
                        camera.updateMatrixWorld(true);
                        const hitTestResults = frame.getHitTestResults(hitTestSource);
                        if (hitTestResults.length > 0 && reticle) 
                        {
                            const hitPose = hitTestResults[0].getPose(referenceSpace);
                            reticle.visible = true;
                            reticle.position.set(hitPose.transform.position.x, hitPose.transform.position.y, hitPose.transform.position.z)
                            reticle.updateMatrixWorld(true);
                        }
                        renderer.render(scene, camera);
                    }
                };
                session.requestAnimationFrame(onXRFrame);

                // Manejar el cierre de la sesión de WebXR
                const onSessionEnd = () => 
                {
                    session.removeEventListener('end', onSessionEnd);
                    renderer.dispose(); // Liberar los recursos del renderizador
                    canvas.remove(); // Eliminar el canvas de la página
                };
                session.addEventListener('end', onSessionEnd);

            } 
            catch (error) 
            {
                console.error('Error al iniciar la experiencia de AR:', error);
            }
        }
    </script>
</body>
</html>
